<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>Hangfájl időbélyegző</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 2em;
      background-color: #121212;
      color: #e0e0e0;
    }

    button, input[type="text"], input[type="file"] {
      margin-top: 0.5em;
      padding: 0.5em;
      background-color: #1f1f1f;
      color: #e0e0e0;
      border: 1px solid #444;
      border-radius: 4px;
    }

    button:hover {
      background-color: #333;
    }

    ul {
      list-style-type: none;
      padding: 0;
    }

    li {
      margin: 4px 0;
    }

    audio {
      width: 100%;
      margin: 1em 0;
    }

    #speedControl {
      margin-top: 1em;
    }
  </style>
</head>
<body>

  <h1>Hangfájl időbélyegző</h1>

  <input type="file" id="fileInput" accept="audio/*"><br>
  <audio id="audioPlayer" controls></audio><br>

  <label for="labelInput">Címkenév:</label>
  <input type="text" id="labelInput" placeholder="hiba">
  <br>

  <button id="timestampButton">Időbélyeg rögzítése</button>
  <button id="exportButton">Exportálás (Audacity TXT)</button>
  <br>
  <input type="file" id="importInput" accept=".txt">
  <br>

  <label for="speedControl">Lejátszási sebesség:</label>
  <input type="range" id="speedControl" min="0.5" max="2" step="0.1" value="1">
  <span id="speedDisplay">1.0x</span>

  <div id="timestamps">
    <h2>Időbélyegek</h2>
    <ul id="timestampList"></ul>
  </div>

  <script>
    const fileInput = document.getElementById('fileInput');
    const audioPlayer = document.getElementById('audioPlayer');
    const timestampButton = document.getElementById('timestampButton');
    const exportButton = document.getElementById('exportButton');
    const timestampList = document.getElementById('timestampList');
    const labelInput = document.getElementById('labelInput');
    const importInput = document.getElementById('importInput');
    const speedControl = document.getElementById('speedControl');
    const speedDisplay = document.getElementById('speedDisplay');

    let timestamps = [];
    let audioFileName = "audacity_cimkek";

    audioPlayer.preservesPitch = true;

    fileInput.addEventListener('change', function () {
      const file = fileInput.files[0];
      if (file) {
        const url = URL.createObjectURL(file);
        audioPlayer.src = url;
        audioFileName = file.name.replace(/\.[^/.]+$/, ""); // remove extension
        timestamps = [];
        timestampList.innerHTML = "";
      }
    });

    timestampButton.addEventListener('click', function () {
      const currentTime = audioPlayer.currentTime;
      const label = labelInput.value.trim() || "hiba";
      timestamps.push({ time: currentTime, label });

      const li = document.createElement('li');
      li.textContent = `${formatClockTime(currentTime)} – ${label}`;
      timestampList.appendChild(li);

      labelInput.value = ""; // clear input after saving
    });

    exportButton.addEventListener('click', function () {
      if (timestamps.length === 0) return;

      const lines = timestamps.map(entry => {
        const fixed = entry.time.toFixed(6);
        return `${fixed}\t${fixed}\t${entry.label}`;
      });

      const content = lines.join('\n');
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = `${audioFileName}.txt`;
      a.click();

      URL.revokeObjectURL(url);
    });

    importInput.addEventListener('change', function () {
      const file = importInput.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        const content = e.target.result;
        const lines = content.trim().split('\n');
        timestamps = [];
        timestampList.innerHTML = "";

        let lastTime = 0;
        lines.forEach(line => {
          const [start, , label] = line.split('\t');
          const time = parseFloat(start);
          if (!isNaN(time)) {
            timestamps.push({ time, label });
            const li = document.createElement('li');
            li.textContent = `${formatClockTime(time)} – ${label}`;
            timestampList.appendChild(li);
            if (time > lastTime) lastTime = time;
          }
        });

        // Ugrás az utolsó időbélyeghez
        audioPlayer.currentTime = lastTime;
      };
      reader.readAsText(file);
    });

    speedControl.addEventListener('input', function () {
      const rate = parseFloat(speedControl.value);
      audioPlayer.playbackRate = rate;
      speedDisplay.textContent = `${rate.toFixed(1)}x`;
    });

    function formatClockTime(seconds) {
      const hrs = Math.floor(seconds / 3600);
      const mins = Math.floor((seconds % 3600) / 60);
      const secs = Math.floor(seconds % 60);
      return `${hrs}.${mins.toString().padStart(2, '0')}.${secs.toString().padStart(2, '0')}`;
    }

labelInput.addEventListener('keydown', function (e) {
  if (e.key === 'Enter') {
    e.preventDefault(); // ne küldje el űrlapként, ha formban van
    timestampButton.click();
  }
});

  </script>

</body>
</html>
